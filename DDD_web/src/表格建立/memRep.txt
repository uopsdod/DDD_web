
-- DROP的順序: 從最沒有被FK到的table開始
-- 如何判斷: 連到table的數字是1的，就是被別的table FK的
DROP TABLE memrep;
DROP TABLE ord;
DROP TABLE room;
DROP TABLE hotel;
DROP TABLE mem;
DROP TABLE emp;


DROP SEQUENCE mem_seq;
DROP SEQUENCE hotel_seq;
DROP SEQUENCE ord_seq;
DROP SEQUENCE emp_seq;
DROP SEQUENCE room_seq;
DROP SEQUENCE memrep_seq;


CREATE TABLE mem(
  memId VARCHAR2(10) NOT NULL,
  CONSTRAINT mem_memId_pk PRIMARY KEY (memId)
);
--驗證用
--SELECT * FROM user_constraints
--WHERE table_name = 'MEM';

CREATE SEQUENCE mem_seq
INCREMENT BY 1
START WITH 1000000001
NOMAXVALUE
NOCYCLE
NOCACHE;

CREATE TABLE hotel(
  hotelId VARCHAR2(5) NOT NULL,
  CONSTRAINT hotel_hotelId_pk PRIMARY KEY (hotelId)
);
--驗證用
--SELECT * FROM user_constraints
--WHERE table_name = 'HOTEL';

CREATE SEQUENCE hotel_seq
INCREMENT BY 1
START WITH 10001
NOMAXVALUE
NOCYCLE
NOCACHE;

CREATE TABLE emp(
  empId VARCHAR2(5) NOT NULL,
  CONSTRAINT emp_empId_pk PRIMARY KEY (empId)
);

CREATE SEQUENCE emp_seq
INCREMENT BY 1
START WITH 10001
NOMAXVALUE
NOCYCLE
NOCACHE;

CREATE TABLE room(
  roomId VARCHAR2(7) NOT NULL,
  roomHotelId VARCHAR2(5) NOT NULL,
  CONSTRAINT room_roomId_pk PRIMARY KEY (roomId),
  CONSTRAINT room_roomHotelId_fk FOREIGN KEY (roomHotelId) REFERENCES hotel(hotelId)
);

CREATE SEQUENCE room_seq
INCREMENT BY 1
START WITH 100001
NOMAXVALUE
NOCYCLE
NOCACHE;

CREATE TABLE ord(
  ordId VARCHAR2(10) NOT NULL,
  ordMemId VARCHAR2(10) NOT NULL,
  ordRoomId VARCHAR2(7) NOT NULL,
  ordHotelId VARCHAR2(5) NOT NULL,
  CONSTRAINT ord_ordId_pk PRIMARY KEY (ordId),
  CONSTRAINT ord_ordMemId_fk FOREIGN KEY (ordMemId) REFERENCES mem(memId),
  CONSTRAINT ord_ordRoomId_fk FOREIGN KEY (ordRoomId) REFERENCES room(roomId),
  CONSTRAINT ord_ordHotelId_fk FOREIGN KEY (ordHotelId) REFERENCES hotel(hotelId)
);
--驗證用
--SELECT * FROM user_constraints
--WHERE table_name = 'ORD';

CREATE SEQUENCE ord_seq
INCREMENT BY 1
START WITH 1001
NOMAXVALUE
NOCYCLE
NOCACHE;


CREATE TABLE memrep( 
  memrepId VARCHAR2(10) NOT NULL,
  memrepOrdId VARCHAR2(10) NOT NULL,
  memrepMemId VARCHAR2(10) NOT NULL,
  memrepHotelId VARCHAR2(5) NOT NULL,
  memrepEmpId VARCHAR2(8), --只有審核之後才會填入資料，因此可以是Null
  memrepContent VARCHAR2(150),
  memrepStatus VARCHAR2(1),
  memrepDate DATE,
  memrepReviewDate DATE,
  
  CONSTRAINT memrep_memrepId_pk PRIMARY KEY (memrepId),
  CONSTRAINT memrep_memrepOrdId_fk FOREIGN KEY (memrepOrdId) REFERENCES ord(ordId),
  CONSTRAINT memrep_memrepMemId_fk FOREIGN KEY (memrepMemId) REFERENCES mem(memId),  
  CONSTRAINT memrep_memrepHotelId_fk FOREIGN KEY (memrepHotelId) REFERENCES hotel(hotelId),  
  CONSTRAINT memrep_memrepEmpId_fk FOREIGN KEY (memrepEmpId) REFERENCES emp(empId)  
);
--驗證用
--SELECT * FROM user_constraints
--WHERE table_name = 'MEMREP';

CREATE SEQUENCE memrep_seq
INCREMENT BY 1
START WITH 1000000001
NOMAXVALUE
NOCYCLE
NOCACHE;

-- 開始新增很真的假資料
--****** hotel ****** 
-- 第一間hotel
INSERT INTO hotel
VALUES(hotel_seq.NEXTVAL);
-- 第二間hotel
INSERT INTO hotel
VALUES(hotel_seq.NEXTVAL);

--****** room ****** 
-- 屬於第一間hotel的第一個房型
INSERT INTO room
VALUES(room_seq.NEXTVAL,
      (select hotelid 
       from (select rownum rnum, hotelid
             from hotel
             where rownum <= 1)
       where rnum >= 1));
-- 屬於第一間hotel的第二個房型
INSERT INTO room
VALUES(room_seq.NEXTVAL,
      (select hotelid 
       from (select rownum rnum, hotelid
             from hotel
             where rownum <= 1)
       where rnum >= 1));
-- 屬於第二間hotel的第一個房型
INSERT INTO room
VALUES(room_seq.NEXTVAL,
      (select hotelid 
       from (select rownum rnum, hotelid
             from hotel
             where rownum <= 2)
       where rnum >= 2));
-- 屬於第二間hotel的第二個房型
INSERT INTO room
VALUES(room_seq.NEXTVAL,
      (select hotelid 
       from (select rownum rnum, hotelid
             from hotel
             where rownum <= 2)
       where rnum >= 2));
-- 屬於第二間hotel的第三個房型
INSERT INTO room
VALUES(room_seq.NEXTVAL,
      (select hotelid 
       from (select rownum rnum, hotelid
             from hotel
             where rownum <= 2)
       where rnum >= 2));

--****** mem ******
-- 第一個一般會員
INSERT INTO mem
VALUES(mem_seq.NEXTVAL);
-- 第二個一般會員
INSERT INTO mem
VALUES(mem_seq.NEXTVAL);

--****** ord ****** 
-- 第一個會員，在昨天，訂了第一個房間(且附上此房間的旅館ID)
INSERT INTO ord 
VALUES ( to_char((sysdate-1),'yyyydd')||ord_seq.NEXTVAL ,
         (select memid 
          from (select rownum rnum, memid
                from mem
                where rownum <= 1)
          where rnum >= 1),
         (select roomId 
          from (select rownum rnum, roomId
                from room
                where rownum <= 1)
          where rnum >= 1),
          (select roomHotelId 
          from (select rownum rnum, roomId, roomHotelId
                from room
                where rownum <= 1)
          where rnum >= 1)
          );
 
-- 第一個會員，在今天，訂了第二個房間(且附上此房間的旅館ID)          
INSERT INTO ord 
VALUES ( to_char((sysdate),'yyyydd')||ord_seq.NEXTVAL ,
         (select memid 
          from (select rownum rnum, memid
                from mem
                where rownum <= 1)
          where rnum >= 1),
         (select roomId 
          from (select rownum rnum, roomId
                from room
                where rownum <= 2)
          where rnum >= 2),
          (select roomHotelId 
          from (select rownum rnum, roomId, roomHotelId
                from room
                where rownum <= 2)
          where rnum >= 2)
          );          

-- 第二個會員，在昨天，訂了第三個房間(且附上此房間的旅館ID)       
INSERT INTO ord 
VALUES ( to_char((sysdate-1),'yyyydd')||ord_seq.NEXTVAL ,
         (select memid 
          from (select rownum rnum, memid
                from mem
                where rownum <= 2)
          where rnum >= 2),
         (select roomId 
          from (select rownum rnum, roomId
                from room
                where rownum <= 3)
          where rnum >= 3),
          (select roomHotelId 
          from (select rownum rnum, roomId, roomHotelId
                from room
                where rownum <= 3)
          where rnum >= 3)
          );            

-- 第二個會員，在今天，訂了第五個房間(且附上此房間的旅館ID)  
INSERT INTO ord 
VALUES ( to_char((sysdate),'yyyydd')||ord_seq.NEXTVAL ,
         (select memid 
          from (select rownum rnum, memid
                from mem
                where rownum <= 2)
          where rnum >= 2),
         (select roomId 
          from (select rownum rnum, roomId
                from room
                where rownum <= 5)
          where rnum >= 5),
          (select roomHotelId 
          from (select rownum rnum, roomId, roomHotelId
                from room
                where rownum <= 5)
          where rnum >= 5)
          );   

--****** emp ****** 
INSERT INTO emp
VALUES (emp_seq.NEXTVAL);
INSERT INTO emp
VALUES (emp_seq.NEXTVAL);
INSERT INTO emp
VALUES (emp_seq.NEXTVAL);


--****** memrep ****** 
-- 此檢舉單根據第一個訂單提出(根據訂單，附上memId以及hotelId)，且尚未處理
INSERT INTO memrep (memrepId, memrepOrdId, memrepMemId, memrepHotelId, memrepEmpId, memrepContent, memrepStatus,memrepDate,memrepReviewDate  )
VALUES ( memrep_seq.NEXTVAL,
        (select ordid 
          from (select rownum rnum, ordid
                from ord
                where rownum <= 1)
          where rnum >= 1), 
        (select ordmemid
          from (select rownum rnum, ordid, ordmemid
                from ord
                where rownum <= 1)
          where rnum >= 1),
        (select ordhotelid
          from (select rownum rnum, ordid, ordhotelid
                from ord
                where rownum <= 1)
          where rnum >= 1),
          null,
          '此旅館的服務態度很差',
          0, --0.未審核 1.已審核未通過 2.已審核已通過
          sysdate, -- 檢舉單提出日
          null
          );
-- 有空再補強: 增加check - 欄位: memrepEmpId, memrepStatus, memrepReviewDate 有連動關係

-- 此檢舉單根據第三個訂單提出(根據訂單，附上memId以及hotelId)，且已由第一位員工處理，在隔天
INSERT INTO memrep (memrepId, memrepOrdId, memrepMemId, memrepHotelId, memrepEmpId, memrepContent, memrepStatus,memrepDate,memrepReviewDate  )
VALUES ( memrep_seq.NEXTVAL,
        (select ordid 
          from (select rownum rnum, ordid
                from ord
                where rownum <= 3)
          where rnum >= 3), 
        (select ordmemid
          from (select rownum rnum, ordid, ordmemid
                from ord
                where rownum <= 3)
          where rnum >= 3),
        (select ordhotelid
          from (select rownum rnum, ordid, ordhotelid
                from ord
                where rownum <= 3)
          where rnum >= 3),
          (select empid
          from (select rownum rnum, empid
                from emp
                where rownum <= 1)
          where rnum >= 1), -- 第一位員工
          '我到了旅館，他們卻要跟我說兩倍的價格，太可惡。',
          2, --0.未審核 1.已審核未通過 2.已審核已通過
          sysdate-1, --檢舉單提出日
          sysdate --檢舉單審核日
          );
-- 有空再補強: 當審核狀態更改為2，要連動將一般會員的'黑名單狀態'作相對應更動          
commit;
--here

select * from hotel;
select * from room;
select * from mem;
select * from ord;
select * from emp;
select * from memrep;



-- 把假資料的FK建起來
-- table規則 - PK - FK
-- emp table
